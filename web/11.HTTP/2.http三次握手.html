<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>2.http三次握手</title>
</head>

<body>
    <p>起初，服务器和客户端都为CLOSED状态。在通信开始前，双方都得创建各自的传输控制块（TCB）。
        <br> 服务器创建完TCB后遍进入LISTEN状态，此时准备接收客户端发来的连接请求。
    </p>
    <br>
    <p>第一次握手：客户端向服务端发送连接请求报文段。该报文段的头部中SYN=1，ACK=0，seq=x。请求发送后，客户端便进入SYN-SENT状态。</p>
    <ul>
        <li>注意1：SYN=1，ACK=0表示该报文段为连接请求报文。</li>
        <li>注意2：x为本次TCP通信的字节流的初始序号。
            <br>TCP规定：SYN=1的报文段不能有数据部分，但要消耗掉一个序号。</li>
    </ul>
    <p>第二次握手：服务端收到连接请求报文段后，如果同意连接，则会发送一个应答：SYN=1，ACK=1，Seq=y，ack=x+1。
        <br> 该应答发送完成后便进入SYN-RCVD状态。
    </p>
    <ul>
        <li>注意1：SYN=1，ACK=1表示该报文段为连接同意的应答报文。</li>
        <li>注意2：seq=y表示服务端作为发送者时，发送字节流的初始序号。</li>
        <li>注意3：ACK=x+1表示服务端希望下一个数据报发送序号从x+1开始的字节。</li>
    </ul>
    <p>第三次握手：当客户端收到连接同意的应答后，还要向服务端发送一个确认报文段，表示：服务端发来的连接同意应答已经成功收到。
        <br> 该报文段的头部为：ACK=1，Seq=x+1，ack=y+1。
        <br> 客户端发完这个报文段后便进入ESTABLISHED状态，服务端收到这个应答后也进入ESTABLISHED状态，此时连接的建立完成！
    </p>
    <br>
    <p>为什么要进行三次握手？</p>
    <ul>
        <li>防止失效的连接请求报文段被服务端接收，从而产生错误。</li>
        <li>失效的连接请求：若客户端向服务端发送的连接请求丢失，客户端等待应答超时后就会再次发送连接请求，此时，上一个连接请求就是『失效的』。</li>
        <li>若建立连接只需两次握手，客户端并没有太大的变化，仍然需要获得服务端的应答后才进入ESTABLISHED状态，而服务端在收到连接请求后就进入ESTABLISHED状态。此时如果网络拥塞，客户端发送的连接请求迟迟到不了服务端，客户端便超时重发请求，如果服务端正确接收并确认应答，双方便开始通信，通信结束后释放连接。
            <br>此时，如果那个失效的连接请求抵达了服务端，由于只有两次握手，服务端收到请求就会进入ESTABLISHED状态，等待发送数据或主动发送数据。但此时的客户端早已进入CLOSED状态，服务端将会一直等待下去，这样浪费服务端连接资源。</li>

    </ul>
</body>

</html>